
# `fudgebundle` reference

## Basic usage

`fudgebundle` generates a PSXFudge bundle file from a set of source images,
sounds and other files. The list of source assets is read from a JSON
configuration file which can be written manually, processed by a templating tool
(e.g. CMake's `configure_file()`) or autogenerated.

This is what a typical configuration file looks like:

```json5
[
  {
    "name": "character_{sprite}",
    "type": "texture",
    "from": "assets/characters.xml",
    "bpp":  4
  },
  {
    "name":  "sword",
    "type":  "texture",
    "from":  "assets/items.xml",
    "match": "^sword",
    "scale": 0.5
  },
  {
    "name": "click",
    "type": "sound",
    "from": "assets/click.wav",
    "sampleRate": 22050
  }
]
```

The root element is always a list of objects. Each object describes a single
entry within the bundle (or in some cases a set of entries of the same type)
through a set of *properties*. Some properties are valid and mandatory for all
asset types, others only apply to a specific type (e.g. `bpp` for textures or
`sampleRate` for sounds). All properties are listed [below](#properties).

## Command-line options

`fudgebundle` is normally invoked manually or through a build system, by passing
the path to the configuration file followed by the full path to the bundle file
that shall be generated:

```bash
fudgebundle path/to/config.json output.fud
```

A number of command-line options are also accepted, most of which alter the
behavior of the VRAM texture packer:

- `-v`: enables verbose logging and status messages. By default only warnings
  and error messages are output. Detailed debug logging can be enabled by
  passing `-vv` but may slow down the tool significantly.

- `-D <step>`, `--discard-step <step>`: sets the speed/accuracy ratio of the
  texture packer. An integer between 1 and 128 must be specified, with 1 being
  the slowest and most accurate mode (default).

- `-T`, `--try-splits`: runs the packer multiple times using different criteria
  to split the space remaining after packing each texture. May occasionally
  result in a better packing ratio, but generally tends to worsen it.

- `-P`, `--preserve-palettes`: by default, to reduce the amount of VRAM taken up
  by palettes, those that are "similar" enough (i.e. only differ by a single bit
  in any of the RGB values) to another palette already present in the bundle are
  removed and the existing palette is used instead. If this option is passed,
  only palettes that are exactly identical will be deduplicated.

- `-A <file>`, `--dump-atlas <file>`: saves a dump of all generated texture
  pages side-by-side, viewed as 4 bits per pixel, as an image to the specified
  path. This option is useful to visually inspect the output of the texture
  packer and evaluate overall VRAM usage.

- `-s <property>=<value>`, `--set <property>=<value>`: sets the default value of
  a property, i.e. the value it will assume for each asset for which another
  value is not specified in its respective configuration file entry. The value
  must be specified using JSON syntax, so explicit quotes are required around it
  if it is a string (rather than a number).

  **NOTE**: if invoking `fudgebundle` from PowerShell, quotes surrounding string
  values also need to be escaped using a backslash-backtick sequence as follows:

  ```powershell
  fudgebundle -s property=\`"value\`" ...
  ```

- `-S <property>=<value>`, `--force-set <property>=<value>`: similar to `-s`,
  but forcefully overrides a property for *all* assets regardless of the
  properties specified per-asset in the configuration file.

- `-p <file>`, `--properties <file>`: behaves similarly to `-s`, but reads
  default property values from the root object of the given JSON file.

## Properties

### Properties common to all asset types

The following properties are always mandatory and must be present for each
asset listed in the configuration file.

- `type` (string or int): self-explanatory. The following asset types are
  currently supported:

  - `texture`: a 4/8/16bpp texture placed in the VRAM data section, optionally
    animated and/or mipmapped.
  - `itexture`: similar to `texture`, but each frame is split into odd and even
    fields.
  - `sound`: a mono or stereo audio file placed into the SPU RAM section.
  - `stringTable`: an array of strings, with each string being indexed by name.
  - `file`: an arbitrary text or binary file embedded as-is into the main RAM
    data section and assigned type ID `0x0000`.

  Alternatively, this field can be set to an integer in `0x8000`-`0xffff` range
  to embed an arbitrary file with the respective custom type ID.

- `from` (string): path to the source file *relative to the directory*
  *`fudgebundle` is invoked from* (rather than to the location of the
  configuration or output files).

  For textures this can be a path to a single image, a glob expression (e.g.
  `character/frame*.png`) to match multiple frames of an animation, or a path to
  an Adobe Animate XML or JSON spritesheet. Even if Adobe Animate was not used
  to author the assets, a spritesheet file can be written manually to import
  individual sprites from an existing pre-packed spritesheet. An example
  spritesheet in both formats is shown below.

  ```xml
  <?xml version="1.0" encoding="utf-8"?>
  <!-- Path to the spritesheet image relative to the XML's location -->
  <TextureAtlas imagePath="sprites.png">
    <!-- Example 32x32 sprite with 3 frames -->
    <SubTexture name="character0000" x="0"  y="0" width="32" height="32" />
    <SubTexture name="character0001" x="32" y="0" width="32" height="32" />
    <SubTexture name="character0002" x="64" y="0" width="32" height="32" />
    <!-- Example 48x48 sprite (with 8 pixels of empty border on all sides,
    stored as 32x32 in the spritesheet) with 3 frames -->
    <SubTexture name="monster0000"
      x="0" y="32" width="32" height="32"
      frameX="8" frameY="8" frameWidth="48" frameHeight="48"
    />
    <SubTexture name="monster0001"
      x="32" y="32" width="32" height="32"
      frameX="8" frameY="8" frameWidth="48" frameHeight="48"
    />
    <SubTexture name="monster0002"
      x="64" y="32" width="32" height="32"
      frameX="8" frameY="8" frameWidth="48" frameHeight="48"
    />
  </TextureAtlas>
  ```

  ```json5
  {
    "meta": {
      // Path to the spritesheet image relative to the JSON's location
      "image": "sprites.png"
    },
    "frames": {
      // Example 32x32 sprite with 3 frames
      "character0000": {
        "frame": { "x": 0, "y": 0, "w": 32, "h": 32 }
      },
      "character0001": {
        "frame": { "x": 32, "y": 0, "w": 32, "h": 32 }
      },
      "character0002": {
        "frame": { "x": 64, "y": 0, "w": 32, "h": 32 }
      },
      // Example 48x48 sprite (with 8 pixels of empty border on all sides,
      // stored as 32x32 in the spritesheet) with 3 frames
      "monster0000": {
        "frame":            { "x": 0, "y": 32, "w": 32, "h": 32 },
        "spriteSourceSize": { "x": 8, "y": 8,  "w": 48, "h": 48 },
        "trimmed": true
      },
      "monster0001": {
        "frame":            { "x": 32, "y": 32, "w": 32, "h": 32 },
        "spriteSourceSize": { "x": 8,  "y": 8,  "w": 48, "h": 48 },
        "trimmed": true
      },
      "monster0002": {
        "frame":            { "x": 64, "y": 32, "w": 32, "h": 32 },
        "spriteSourceSize": { "x": 8,  "y": 8,  "w": 48, "h": 48 },
        "trimmed": true
      }
    }
  }
  ```

  If a spritesheet is used, a separate entry will be added to the bundle for
  each texture listed in it. The `{sprite}` placeholder in the `name` property
  will be replaced with each imported texture's name as listed in the
  spritesheet. To import a single texture or animation from a spritesheet, the
  `match` property can be used to whitelist it.

  For sounds, any file format supported by FFmpeg can be imported. Since sounds
  will have to be re-encoded to SPU ADPCM, using lossless source files is highly
  recommended.

  For string tables the source file can be a JSON file whose root element is an
  object, or a text file where each line follows the `<key>=<string>` format.

- `name` (string or int): can be arbitrary but it must be unique for each asset
  in the bundle. Only ASCII characters are allowed. This string is hashed to
  derive the asset's 32-bit identifier; a hash can also be specified explicitly.

  When specifying a spritesheet that contains more than one texture as the
  source, this field must contain a `{sprite}` placeholder that will be replaced
  with each texture's name. This is not required if the `match` property is used
  to ensure only a single texture is going to be imported from the spritesheet.

### Texture properties

- `match` (string): a regular expression to filter out textures in imported
  spritesheets. All entries listed in the spritesheet but whose name does not
  match the specified expression will be ignored.

  This property is useful for applying different properties to textures in the
  same spritesheet. For instance, if `character` and `monster` are both in the
  same spritesheet but require different properties, they can be specified as
  two separate entries with an appropriate regular expression to ensure only one
  is imported at a time:

  ```json
  [
    {
      "name":  "character",
      "type":  "texture",
      "from":  "assets/sprites.xml",
      "match": "^character",
      "scale": 0.5
    },
    {
      "name":  "monster",
      "type":  "texture",
      "from":  "assets/sprites.xml",
      "match": "^monster",
      "scale": 0.5
    },
  ]
  ```

  See [Python's documentation](https://docs.python.org/3/library/re.html) for
  more information about regular expression syntax.

  **NOTE**: backslashes in the regular expression will have to be double-escaped
  in order to comply with JSON syntax. A regular expression such as `^\w+` will
  thus have to be written as `"match": "^\\w+"` in the configuration file.

- `frames` (string or list of ints/strings): a list of animation frame indices
  to import from the source file, starting from 0. Frame ranges can be specified
  as a string using a dash as a separator between the two ends. Additionally, a
  stride can be specified (prefixed with a colon) to skip frames at regular
  intervals. For instance:

  - `0 3-6` will import frames 0, 3, 4, 5, 6;
  - `0-8 9-1:-1` will import frames 0 through 8, then import frames 1 through 9
    again in reverse order (thus creating a "ping-pong" looped animation);
  - `0-8:2` will import even frames in 0-8 range (0, 2, 4, 6, 8);
  - `0-9:2 39-10:-3` will import the first 10 frames but discard half of them,
    then import 30 more frames in reverse order and only keep 1 every 3 frames.

- `mipLevels` (int): how many mipmap levels (downscaled copies) to generate for
  each frame. Mipmaps are useful for 3D model textures, as GPU performance can
  be improved by dynamically switching to lower resolution textures for objects
  that are far away from the camera. For each mipmap level beyond the first one,
  each frame is scaled by `mipScale` and re-quantized. By default only a single
  level, i.e. the full-resolution texture, is generated.

- `crop` (list of 4 ints): a list containing the X/Y offset, width and height
  of the region of each source frame to keep in the converted textures. The
  default value is `[ 0, 0, 65535, 65535 ]`, meaning no cropping will occur.
  Note that cropping is done *before* rescaling (see below).

- `scale` (float): scale factor of imported frames. Can be used to downscale a
  texture without having to modify source files. A value of 1.0 (default) will
  disable scaling.

- `mipScale` (float): scale factor of each generated mipmap level after the
  first one, relative to the previous level. Has no effect if `mipLevels` is 1.
  The default value is 0.5, meaning each mipmap level will halve the horizontal
  and vertical resolution of the texture.

- `bpp` (int): must be 4 (default), 8 or 16. Note that for 8bpp textures this
  property must be specified explicitly *even if the source images are in an*
  *indexed color format with 256 colors*. If the source images are in an indexed
  color format incompatible with the specified color depth (e.g. more than 16
  colors with the default value of 4bpp) they will be converted back to RGB and
  re-quantized, potentially degrading quality.

- `palette` (string): which palette preset to use when quantizing the source
  images to 4bpp or 8bpp (has no effect if `bpp` is 16). Must be one of the
  following values:

  - `auto` (default): generate an optimal palette for each frame;
  - `mono4`: use a fixed palette with 16 solid shades of gray;
  - `monoAlpha4`: use a fixed palette with 8 solid shades and 4 semitransparent
    shades of gray:
  - `mono8`: use a fixed palette with 256 solid shades of gray;
  - `monoAlpha8`: use a fixed palette with 128 solid shades and 127
    semitransparent shades of gray.

  If the source images are in an indexed color format and a value other than
  `auto` is specified they will be converted back to RGB and re-quantized,
  potentially degrading quality.

- `dither` (float): the amount of dithering to apply when quantizing the source
  frames. Must be a value from 0.0 (default) to 1.0. Has no effect if the source
  frames are already in an indexed color format compatible with the specified
  `bpp` and quantization is skipped.

- `scaleMode` (string): the algorithm to use to rescale the frames. Must be
  `nearest`, `lanczos` (default), `bilinear`, `bicubic`, `box` or `hamming`.
  Has no effect when `scale` is 1.0.

- `alphaRange` (list of 2 ints): the semitransparency range to apply, as a list
  of two values in 0-255 range. Any pixel in source frames whose alpha value
  falls within this range will be converted to a semitransparent pixel; all
  other pixels will be converted to solid or fully transparent depending on
  whether their alpha value is greater than the upper bound or less than the
  lower bound of this range. The default semitransparency range is
  `[ 32, 224 ]`.

- `blackValue` (list of 4 ints): the PS1 16bpp color value to be used for black
  pixels, specified as a list of 3 RGB values in 0-31 range and a blending flag
  in 0-1 range. `[ 0, 0, 0, 0 ]` is not usable as black as it is interpreted by
  the GPU as fully transparent, so by default `[ 1, 1, 1, 0 ]` (dark gray) is
  used instead. If the texture will be drawn with semitransparency disabled,
  `[ 0, 0, 0, 1 ]` (semitransparent black) can be used instead.

- `cropMode` (string): how to handle empty/transparent margins if present in
  any source image. Must be one of the following:

  - `none` (default): keep all margins in converted frames;
  - `preserveMargin`: crop any margins but save their thickness and set the
    margin flag so that they can be restored when drawing the texture;
  - `removeMargin`: crop all margins without saving their thickness.

- `padding` (int): how many rows of empty pixels to leave around each frame
  during packing. This option is useful for 2D assets that are going to be
  drawn as polygons, since the GPU has sampling artifacts that require clearance
  around textures in order to be worked around. By default no padding is added.

- `flipMode` (string): whether the texture packer is allowed to rotate any frame
  of the texture 90 degrees and set the flip flag. This option is disabled by
  default and cannot be enabled if the texture is going to be drawn using a
  rectangle/sprite primitive, which does not support rotation. Must be `none`,
  `preferUnflipped` or `preferFlipped`.

### Sound properties

- `sampleRate` (int): if non-zero, the source audio file will be resampled to
  the specified sampling rate before being converted to ADPCM. This property is
  useful for reducing the amount of SPU RAM taken up by a sound without having
  to modify the source file.

- `channels` (int): must be 1 (mono, default) or 2 (stereo). Stereo sounds take
  up double the amount of SPU RAM.

- `loopOffset` (float): can be specified to enable looping. After the sample is
  played once, it will be played again starting from the specified offset in
  seconds (from the beginning if zero). A negative value will disable looping.

## String table properties

- `encoding` (string): the text encoding to use for strings. See the
  [Python documentation](https://docs.python.org/3/library/codecs.html#standard-encodings)
  for a list of supported encodings. The default encoding is strict ASCII, with
  an error being thrown if the source file contains non-ASCII characters.

- `align` (int): number of bytes all strings will be aligned to (4 by default).
  Strings are aligned by inserting null bytes in between as padding.

-----------------------------------------
_Last updated on 2023-05-01 by spicyjpeg_
